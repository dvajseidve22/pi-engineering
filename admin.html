<!DOCTYPE html>
<html lang="mk">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Админ панел</title>
    <link rel="stylesheet" href="./styling/admin.css" />
  </head>
  <body>
    <header>
      <h1>Админ панел</h1>
      <div>
        <span id="who" class="muted"></span>
        <button id="logoutBtn" class="btn">Одјава</button>
      </div>
    </header>

    <main>
      <section class="card">
        <h3>Нов пост</h3>

        <!-- Наслов + Слики -->
        <div class="row">
          <input
            id="title"
            type="text"
            placeholder="Наслов (пример KIA Picanto 1.2 GT)"
          />
          <input id="image" type="file" accept="image/*" multiple />
        </div>

        <!-- KM + Year + Цена (numeric CHF) -->
        <div class="row-3">
          <input
            id="km"
            type="number"
            inputmode="numeric"
            placeholder="KM (пример 5420)"
            min="0"
            step="1"
          />
          <input
            id="year"
            type="number"
            inputmode="numeric"
            placeholder="Година (пример 2024)"
            min="1980"
            max="2099"
            step="1"
          />
          <div>
            <input
              id="price"
              type="number"
              inputmode="numeric"
              placeholder="Цена во CHF (пример 23000)"
              min="0"
              step="100"
            />
            <div id="pricePreview" class="preview"></div>
          </div>
        </div>

        <!-- Гориво + Менувач -->
        <div class="row-3">
          <select id="fuel">
            <option value="">Гориво (опц.)</option>
            <option>Benzin</option>
            <option>Diesel</option>
            <option>Hybrid</option>
            <option>Elektro</option>
            <option>LPG</option>
            <option>CNG</option>
          </select>
          <select id="gearbox">
            <option value="">Менувач (опц.)</option>
            <option>Manuell</option>
            <option>Automatik</option>
          </select>
          <div></div>
        </div>

        <textarea id="description" placeholder="Опис..."></textarea>

        <div class="bar">
          <button id="uploadBtn" class="btn primary">Објави</button>
          <div id="msg" class="muted"></div>
        </div>
      </section>

      <section class="card">
        <h3>Постови</h3>
        <div id="posts" class="grid"></div>
      </section>
    </main>

    <script type="module">
      import { supabase } from "./supabase-config.js";

      const who = document.getElementById("who");
      const logoutBtn = document.getElementById("logoutBtn");
      const uploadBtn = document.getElementById("uploadBtn");
      const titleInput = document.getElementById("title");
      const descInput = document.getElementById("description");
      const kmInput = document.getElementById("km");
      const yearInput = document.getElementById("year");
      const priceInput = document.getElementById("price");
      const pricePreview = document.getElementById("pricePreview");
      const fuelInput = document.getElementById("fuel");
      const gearboxInput = document.getElementById("gearbox");
      const fileInput = document.getElementById("image");
      const postsDiv = document.getElementById("posts");
      const msg = document.getElementById("msg");

      // ===== auth =====
      const {
        data: { session },
      } = await supabase.auth.getSession();
      if (!session) location.href = "login.html";
      else who.textContent = session.user.email;

      logoutBtn.onclick = async () => {
        await supabase.auth.signOut();
        location.href = "login.html";
      };

      // ===== helpers =====
      const fmtCHF = (n) =>
        Number.isFinite(n)
          ? "CHF " +
            new Intl.NumberFormat("de-CH", { maximumFractionDigits: 0 }).format(
              n
            )
          : "";

      const formatNumber = (n) => {
        try {
          return new Intl.NumberFormat("mk-MK").format(n);
        } catch {
          return String(n);
        }
      };

      const escapeHtml = (s) =>
        String(s ?? "").replace(
          /[&<>\"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );

      priceInput.addEventListener("input", () => {
        const n = Number(priceInput.value || "");
        pricePreview.textContent = fmtCHF(n);
      });

      // ===== create =====
      uploadBtn.onclick = async () => {
        msg.textContent = "";
        const title = titleInput.value.trim();
        const description = descInput.value.trim();
        const files = fileInput.files;

        const kmValue = kmInput.value.trim()
          ? Number(kmInput.value.trim())
          : null;
        const yearValue = yearInput.value.trim()
          ? Number(yearInput.value.trim())
          : null;
        const priceVal = priceInput.value.trim()
          ? Number(priceInput.value.trim())
          : null;
        const fuel = fuelInput.value || null;
        const gearbox = gearboxInput.value || null;

        if (!title || !description || !files.length) {
          msg.textContent =
            "Пополнете ги задолжителните полиња (наслов, опис и слики).";
          return;
        }

        // upload images
        const imageUrls = [];
        for (const file of files) {
          const fileName = `${Date.now()}_${file.name}`.replace(/\s+/g, "_");
          const { error: upErr } = await supabase.storage
            .from("images")
            .upload(fileName, file, { cacheControl: "3600", upsert: false });
          if (upErr) {
            msg.textContent = "Грешка при upload: " + upErr.message;
            return;
          }
          const { data: urlData } = supabase.storage
            .from("images")
            .getPublicUrl(fileName);
          imageUrls.push(urlData.publicUrl);
        }

        // insert (користиме постоечка numeric 'price' колона)
        const payload = {
          title,
          description,
          images: imageUrls,
          km: kmValue,
          year: yearValue,
          price: priceVal,
          fuel,
          gearbox,
        };
        const { error: dbErr } = await supabase.from("posts").insert([payload]);
        if (dbErr) {
          msg.textContent = "DB грешка: " + dbErr.message;
          return;
        }

        msg.textContent = "Објавено ✔";
        titleInput.value = "";
        descInput.value = "";
        kmInput.value = "";
        yearInput.value = "";
        priceInput.value = "";
        pricePreview.textContent = "";
        fuelInput.value = "";
        gearboxInput.value = "";
        fileInput.value = "";
        await loadPosts();
      };

      // ===== read/list =====
      async function loadPosts() {
        postsDiv.innerHTML = `<p class="muted">Вчитувам…</p>`;
        const { data: posts, error } = await supabase
          .from("posts")
          .select("id,title,description,images,km,year,price,fuel,gearbox")
          .order("id", { ascending: false });

        if (error) {
          console.error("Supabase select error:", error);
          postsDiv.innerHTML = `<p class="muted">Грешка: ${escapeHtml(
            error.message
          )}</p>`;
          return;
        }
        if (!posts || posts.length === 0) {
          postsDiv.innerHTML = `<p class="muted">Нема објави засега.</p>`;
          return;
        }

        postsDiv.innerHTML = posts
          .map((p) => {
            const imgs = (
              Array.isArray(p.images) ? p.images : [p.images || ""]
            ).filter(Boolean);
            const km = p.km ?? null;
            const year = p.year ?? null;
            const fuel = p.fuel || "";
            const gbox = p.gearbox || "";

            const priceHtml =
              p.price != null && !Number.isNaN(Number(p.price))
                ? `<span class="badge">${fmtCHF(Number(p.price))}</span>`
                : "";

            const fuelHtml = fuel
              ? `<span class="badge">${escapeHtml(fuel)}</span>`
              : "";
            const gboxHtml = gbox
              ? `<span class="badge">${escapeHtml(gbox)}</span>`
              : "";

            return `
        <article class="post">
          ${imgs.map((u) => `<img src="${u}" alt="">`).join("")}
          <div class="p">
            <strong>${escapeHtml(p.title)}</strong>
            <div class="meta">
              ${year ? `<span>Год.: ${year}</span>` : ""}
              ${km !== null ? `<span>KM: ${formatNumber(km)}</span>` : ""}
              ${priceHtml}${fuelHtml}${gboxHtml}
            </div>
            <p class="muted">${escapeHtml(p.description)}</p>
            <div class="bar">
              <button class="btn danger" data-id="${p.id}">Избриши</button>
            </div>
          </div>
        </article>`;
          })
          .join("");

        // delete
        postsDiv.querySelectorAll(".btn.danger").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const id = Number(e.currentTarget.dataset.id);
            if (!confirm("Сигурно сакаш да го избришеш постот?")) return;
            const { error } = await supabase
              .from("posts")
              .delete()
              .eq("id", id);
            if (error) alert(error.message);
            else loadPosts();
          });
        });
      }

      // realtime (правилна сигнатура)
      supabase
        .channel("public:posts")
        .on(
          "postgres_changes",
          { event: "*", schema: "public", table: "posts" },
          loadPosts
        )
        .subscribe();

      await loadPosts();
    </script>
  </body>
</html>
