<!DOCTYPE html>
<html lang="mk">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Админ панел</title>
    <style>
      :root {
        --bg: #0b1324;
        --card: #121a2b;
        --text: #e8eef9;
        --muted: #9fb0d1;
        --brand: #4c8dff;
        --danger: #ff5c5c;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: linear-gradient(180deg, #0b1324, #0f1a33);
        font-family: ui-sans-serif, system-ui, Segoe UI, Arial;
        color: var(--text);
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid #1d2742;
      }
      header h1 {
        font-size: 18px;
        margin: 0;
      }
      .btn {
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid #2a3a66;
        background: transparent;
        color: var(--muted);
        cursor: pointer;
      }
      .btn.primary {
        background: var(--brand);
        color: #fff;
        border: 0;
      }
      main {
        max-width: 980px;
        margin: 24px auto;
        padding: 0 16px;
        display: grid;
        gap: 20px;
      }
      .card {
        background: var(--card);
        border: 1px solid #1d2742;
        border-radius: 16px;
        padding: 18px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      }
      .row {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr 1fr;
      }
      .row-3 {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr 1fr 1fr;
      }
      input,
      textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #22335b;
        background: #0c1430;
        color: var(--text);
        border-radius: 10px;
        outline: 0;
      }
      textarea {
        min-height: 110px;
        resize: vertical;
      }
      .grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      }
      .post {
        border: 1px solid #22335b;
        border-radius: 12px;
        overflow: hidden;
        background: #0c1430;
      }
      .post img {
        width: 100%;
        height: 160px;
        object-fit: cover;
        display: block;
      }
      .post .p {
        padding: 10px 12px;
      }
      .muted {
        color: var(--muted);
        font-size: 13px;
      }
      .danger {
        color: #fff;
        background: var(--danger);
        border: 0;
      }
      .bar {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .meta {
        display: flex;
        gap: 12px;
        font-size: 13px;
        color: var(--muted);
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Админ панел</h1>
      <div>
        <span id="who" class="muted"></span>
        <button id="logoutBtn" class="btn">Одјава</button>
      </div>
    </header>

    <main>
      <section class="card">
        <h3>Нов пост</h3>

        <!-- Наслов + Слики -->
        <div class="row">
          <input id="title" type="text" placeholder="Наслов" />
          <input id="image" type="file" accept="image/*" multiple />
        </div>

        <!-- KM + Year + Опис -->
        <div class="row-3">
          <input
            id="km"
            type="number"
            inputmode="numeric"
            placeholder="KM (пример 185000)"
            min="0"
            step="1"
          />
          <input
            id="year"
            type="number"
            inputmode="numeric"
            placeholder="Година (пример 2018)"
            min="1980"
            max="2099"
            step="1"
          />
          <input
            id="price"
            type="text"
            placeholder="Цена (опц.) пример 7'900 CHF"
          />
        </div>
        <textarea id="description" placeholder="Опис..."></textarea>

        <div class="bar">
          <button id="uploadBtn" class="btn primary">Објави</button>
          <div id="msg" class="muted"></div>
        </div>
      </section>

      <section class="card">
        <h3>Постови</h3>
        <div id="posts" class="grid"></div>
      </section>
    </main>

    <script type="module">
      import { supabase } from "./supabase-config.js";

      const who = document.getElementById("who");
      const logoutBtn = document.getElementById("logoutBtn");
      const uploadBtn = document.getElementById("uploadBtn");
      const titleInput = document.getElementById("title");
      const descInput = document.getElementById("description");
      const kmInput = document.getElementById("km");
      const yearInput = document.getElementById("year");
      const priceInput = document.getElementById("price");
      const fileInput = document.getElementById("image");
      const postsDiv = document.getElementById("posts");
      const msg = document.getElementById("msg");

      // сесија (мора да е најавен)
      const {
        data: { session },
      } = await supabase.auth.getSession();
      if (!session) location.href = "login.html";
      else who.textContent = session.user.email;

      logoutBtn.onclick = async () => {
        await supabase.auth.signOut();
        location.href = "login.html";
      };

      uploadBtn.onclick = async () => {
        msg.textContent = "";
        const title = titleInput.value.trim();
        const description = descInput.value.trim();
        const files = fileInput.files;

        // новите полиња
        const kmValue = kmInput.value.trim()
          ? Number(kmInput.value.trim())
          : null;
        const yearValue = yearInput.value.trim()
          ? Number(yearInput.value.trim())
          : null;
        const price = priceInput.value.trim() || null;

        if (!title || !description || !files.length) {
          msg.textContent =
            "Пополнете ги сите полиња (наслов, опис и најмалку една слика).";
          return;
        }

        // 1) Upload на сите слики
        const imageUrls = [];
        for (const file of files) {
          const fileName = `${Date.now()}_${file.name}`.replace(/\s+/g, "_");
          const { error: upErr } = await supabase.storage
            .from("images")
            .upload(fileName, file, { cacheControl: "3600", upsert: false });
          if (upErr) {
            msg.textContent = "Грешка при upload: " + upErr.message;
            return;
          }
          const { data: urlData } = supabase.storage
            .from("images")
            .getPublicUrl(fileName);
          imageUrls.push(urlData.publicUrl);
        }

        // 2) Запис во базата
        // Заб: ако колоната ти е создадена како "KM" со големи букви, ова ќе работи затоа што праќаме и km и KM.
        const payload = {
          title,
          description,
          images: imageUrls,
          km: kmValue, // <— само km
          year: yearValue, // <— само year
          price,
        };

        const { error: dbErr } = await supabase.from("posts").insert([payload]);
        if (dbErr) {
          msg.textContent = "DB грешка: " + dbErr.message;
          return;
        }

        msg.textContent = "Објавено ✔";
        titleInput.value = "";
        descInput.value = "";
        kmInput.value = "";
        yearInput.value = "";
        priceInput.value = "";
        fileInput.value = "";
        await loadPosts();
      };

      async function loadPosts() {
        const { data: posts, error } = await supabase
          .from("posts")
          .select("*")
          .order("id", { ascending: false });

        if (error) {
          postsDiv.innerHTML = `<p class="muted">${error.message}</p>`;
          return;
        }

        postsDiv.innerHTML = posts
          .map((p) => {
            const km = p.km ?? p.KM ?? null;
            const year = p.year ?? p.YEAR ?? null;
            return `
            <article class="post">
              ${(Array.isArray(p.images) ? p.images : [p.images || p.image])
                .filter(Boolean)
                .map((u) => `<img src="${u}" alt="">`)
                .join("")}
              <div class="p">
                <strong>${escapeHtml(p.title)}</strong>
                <div class="meta">
                  ${year ? `<span>Год.: ${year}</span>` : ""}
                  ${km !== null ? `<span>KM: ${formatNumber(km)}</span>` : ""}
                  ${p.price ? `<span>Цена: ${escapeHtml(p.price)}</span>` : ""}
                </div>
                <p class="muted">${escapeHtml(p.description)}</p>
                <div class="bar">
                  <button class="btn danger" onclick="deletePost(${
                    p.id
                  })">Избриши</button>
                </div>
              </div>
            </article>
          `;
          })
          .join("");
      }

      window.deletePost = async (id) => {
        if (!confirm("Сигурно сакаш да го избришеш постот?")) return;
        const { error } = await supabase.from("posts").delete().eq("id", id);
        if (error) alert(error.message);
        else loadPosts();
      };

      function formatNumber(n) {
        try {
          return new Intl.NumberFormat("mk-MK").format(n);
        } catch {
          return String(n);
        }
      }
      function escapeHtml(s) {
        return String(s ?? "").replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }

      await loadPosts();
    </script>
  </body>
</html>
